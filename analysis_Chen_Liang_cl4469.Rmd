---
title: "Analysis_Chen_Liang_cl4469"
author: "Chen Liang"
date: "2024-03-20"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(caret)
library(mgcv)
library(earth)
```

## Data preparation
```{r}
# Load data
recov_df <- get(load("./data/recovery.RData")) |> 
  janitor::clean_names() |>
  na.omit() |>
  select(-id)

summary(recov_df)
# Create a partition index.(training:test=80:20)
set.seed(2024)
train_index = createDataPartition(y = recov_df$recovery_time,
                                 p = 0.8,
                                 list = FALSE)
# Extract the training and test data
training_df = recov_df[train_index, ]
testing_df = recov_df[-train_index, ]

# Training data
x = model.matrix(recovery_time~.,training_df)[, -1]
y = training_df$recovery_time

# Testing data
x2 <- model.matrix(recovery_time~.,testing_df)[, -1]
y2 <- testing_df$recovery_time

```

## Linear Model
```{r}
set.seed(2024)

# 10-fold cv
ctrl1 <- trainControl(method = "cv", number = 10)

# Fit Model
lm_fit <- train(x, y, method = "lm", trControl = ctrl1)
summary(lm_fit)

# Make predictions on test dataset
lm_test_pred <- predict(lm_fit, newdata = x2) # test dataset

# Calculate test error
lm_test_rmse <- sqrt(mean((lm_test_pred - y2)^2))
lm_test_rmse
```

## Lasso Model
```{r}
set.seed(2024)

# Fit Model
lasso_fit <- train(x, y,
                   data= training_df,
                   method = "glmnet",
                   tuneGrid = expand.grid(alpha = 1, 
                                          lambda = exp(seq(5, -5, length = 100))),
                   trControl = ctrl1)

# Plot RMSE and lambda
plot(lasso_fit, xTrans = log)

# Check best tune
lasso_fit$bestTune

# Obtain coefficients in the final model
coef(lasso_fit$finalModel, s = lasso_fit$bestTune$lambda)

# Make predictions on test dataset
lasso_test_pred <- predict(lasso_fit, newdata = x2)

# Obtain test error 
lasso_test_rmse <- mean((lasso_test_pred - y2)^2)
lasso_test_rmse
```

## Elastic Net Model
```{r}
set.seed(2024)

# Fit Model
enet_fit <- train(x, y,
                  data = training_df,
                  method = "glmnet",
                  tuneGrid = expand.grid(alpha = seq(0, 1, length = 21), 
                                         lambda = exp(seq(7, -3, length = 100))),
                  trControl = ctrl1)

# Check best tune
enet_fit$bestTune

# plot RMSE vs lambda and alpha
myCol <- rainbow(25)
myPar <- list(superpose.symbol = list(col = myCol),
              superpose.line = list(col = myCol))

plot(enet_fit, par.settings = myPar)

# Obtain coefficients in the final model
coef(enet_fit$finalModel, enet_fit$bestTune$lambda)

# Make predictions on test data set
enet_test_pred <- predict(enet_fit, newdata = x2)

# Calculate test error
enet__test_rmse <- mean((enet_test_pred - y2)^2)
enet__test_rmse
```

```{r}


